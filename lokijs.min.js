var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(e,p,h){if(h.get||h.set)throw new TypeError("ES3 does not support getters and setters.");e!=Array.prototype&&e!=Object.prototype&&(e[p]=h.value)};$jscomp.getGlobal=function(e){return"undefined"!=typeof window&&window===e?e:"undefined"!=typeof global&&null!=global?global:e};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(e){return $jscomp.SYMBOL_PREFIX+(e||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.iterator;e||(e=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[e]&&$jscomp.defineProperty(Array.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(e){var p=0;return $jscomp.iteratorPrototype(function(){return p<e.length?{done:!1,value:e[p++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(e){$jscomp.initSymbolIterator();e={next:e};e[$jscomp.global.Symbol.iterator]=function(){return this};return e};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(e,p){$jscomp.initSymbolIterator();e instanceof String&&(e+="");var h=0,k={next:function(){if(h<e.length){var z=h++;return{value:p(z,e[z]),done:!1}}k.next=function(){return{done:!0,value:void 0}};return k.next()}};k[Symbol.iterator]=function(){return k};return k};
$jscomp.polyfill=function(e,p,h,k){if(p){h=$jscomp.global;e=e.split(".");for(k=0;k<e.length-1;k++){var z=e[k];z in h||(h[z]={});h=h[z]}e=e[e.length-1];k=h[e];p=p(k);p!=k&&null!=p&&$jscomp.defineProperty(h,e,{configurable:!0,writable:!0,value:p})}};$jscomp.polyfill("Array.prototype.keys",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(e){return e})}},"es6-impl","es3");$jscomp.owns=function(e,p){return Object.prototype.hasOwnProperty.call(e,p)};
$jscomp.polyfill("Object.assign",function(e){return e?e:function(e,h){for(var k=1;k<arguments.length;k++){var p=arguments[k];if(p)for(var w in p)$jscomp.owns(p,w)&&(e[w]=p[w])}return e}},"es6-impl","es3");$jscomp.findInternal=function(e,p,h){e instanceof String&&(e=String(e));for(var k=e.length,z=0;z<k;z++){var w=e[z];if(p.call(h,w,z,e))return{i:z,v:w}}return{i:-1,v:void 0}};
$jscomp.polyfill("Array.prototype.find",function(e){return e?e:function(e,h){return $jscomp.findInternal(this,e,h).v}},"es6-impl","es3");$jscomp.polyfill("Array.prototype.values",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(e,h){return h})}},"es6","es3");$jscomp.makeIterator=function(e){$jscomp.initSymbolIterator();var p=e[Symbol.iterator];return p?p.call(e):$jscomp.arrayIterator(e)};
$jscomp.polyfill("WeakMap",function(e){function p(e){$jscomp.owns(e,k)||$jscomp.defineProperty(e,k,{value:{}})}function h(e){var q=Object[e];q&&(Object[e]=function(e){p(e);return q(e)})}if(function(){if(!e||!Object.seal)return!1;try{var h=Object.seal({}),q=Object.seal({}),k=new e([[h,2],[q,3]]);if(2!=k.get(h)||3!=k.get(q))return!1;k["delete"](h);k.set(q,4);return!k.has(h)&&4==k.get(q)}catch(B){return!1}}())return e;var k="$jscomp_hidden_"+Math.random().toString().substring(2);h("freeze");h("preventExtensions");
h("seal");var z=0,w=function(e){this.id_=(z+=Math.random()+1).toString();if(e){$jscomp.initSymbol();$jscomp.initSymbolIterator();e=$jscomp.makeIterator(e);for(var q;!(q=e.next()).done;)q=q.value,this.set(q[0],q[1])}};w.prototype.set=function(e,q){p(e);if(!$jscomp.owns(e,k))throw Error("WeakMap key fail: "+e);e[k][this.id_]=q;return this};w.prototype.get=function(e){return $jscomp.owns(e,k)?e[k][this.id_]:void 0};w.prototype.has=function(e){return $jscomp.owns(e,k)&&$jscomp.owns(e[k],this.id_)};w.prototype["delete"]=
function(e){return $jscomp.owns(e,k)&&$jscomp.owns(e[k],this.id_)?delete e[k][this.id_]:!1};return w},"es6-impl","es3");$jscomp.ASSUME_NO_NATIVE_MAP=!1;
$jscomp.polyfill("Map",function(e){if(!$jscomp.ASSUME_NO_NATIVE_MAP&&function(){if(!e||!e.prototype.entries||"function"!=typeof Object.seal)return!1;try{var q=Object.seal({x:4}),h=new e($jscomp.makeIterator([[q,"s"]]));if("s"!=h.get(q)||1!=h.size||h.get({x:4})||h.set({x:4},"t")!=h||2!=h.size)return!1;var k=h.entries(),m=k.next();if(m.done||m.value[0]!=q||"s"!=m.value[1])return!1;m=k.next();return m.done||4!=m.value[0].x||"t"!=m.value[1]||!k.next().done?!1:!0}catch(H){return!1}}())return e;$jscomp.initSymbol();
$jscomp.initSymbolIterator();var p=new WeakMap,h=function(e){this.data_={};this.head_=w();this.size=0;if(e){e=$jscomp.makeIterator(e);for(var q;!(q=e.next()).done;)q=q.value,this.set(q[0],q[1])}};h.prototype.set=function(e,h){var q=k(this,e);q.list||(q.list=this.data_[q.id]=[]);q.entry?q.entry.value=h:(q.entry={next:this.head_,previous:this.head_.previous,head:this.head_,key:e,value:h},q.list.push(q.entry),this.head_.previous.next=q.entry,this.head_.previous=q.entry,this.size++);return this};h.prototype["delete"]=
function(e){e=k(this,e);return e.entry&&e.list?(e.list.splice(e.index,1),e.list.length||delete this.data_[e.id],e.entry.previous.next=e.entry.next,e.entry.next.previous=e.entry.previous,e.entry.head=null,this.size--,!0):!1};h.prototype.clear=function(){this.data_={};this.head_=this.head_.previous=w();this.size=0};h.prototype.has=function(e){return!!k(this,e).entry};h.prototype.get=function(e){return(e=k(this,e).entry)&&e.value};h.prototype.entries=function(){return z(this,function(e){return[e.key,
e.value]})};h.prototype.keys=function(){return z(this,function(e){return e.key})};h.prototype.values=function(){return z(this,function(e){return e.value})};h.prototype.forEach=function(e,h){for(var k=this.entries(),m;!(m=k.next()).done;)m=m.value,e.call(h,m[1],m[0],this)};h.prototype[Symbol.iterator]=h.prototype.entries;var k=function(e,h){var k;k=h&&typeof h;"object"==k||"function"==k?p.has(h)?k=p.get(h):(k=""+ ++A,p.set(h,k)):k="p_"+h;var m=e.data_[k];if(m&&$jscomp.owns(e.data_,k))for(var q=0;q<
m.length;q++){var w=m[q];if(h!==h&&w.key!==w.key||h===w.key)return{id:k,list:m,index:q,entry:w}}return{id:k,list:m,index:-1,entry:void 0}},z=function(e,h){var k=e.head_;return $jscomp.iteratorPrototype(function(){if(k){for(;k.head!=e.head_;)k=k.previous;for(;k.next!=k.head;)return k=k.next,{done:!1,value:h(k)};k=null}return{done:!0,value:void 0}})},w=function(){var e={};return e.previous=e.next=e.head=e},A=0;return h},"es6-impl","es3");$jscomp.ASSUME_NO_NATIVE_SET=!1;
$jscomp.polyfill("Set",function(e){if(!$jscomp.ASSUME_NO_NATIVE_SET&&function(){if(!e||!e.prototype.entries||"function"!=typeof Object.seal)return!1;try{var h=Object.seal({x:4}),k=new e($jscomp.makeIterator([h]));if(!k.has(h)||1!=k.size||k.add(h)!=k||1!=k.size||k.add({x:4})!=k||2!=k.size)return!1;var p=k.entries(),w=p.next();if(w.done||w.value[0]!=h||w.value[1]!=h)return!1;w=p.next();return w.done||w.value[0]==h||4!=w.value[0].x||w.value[1]!=w.value[0]?!1:p.next().done}catch(A){return!1}}())return e;
$jscomp.initSymbol();$jscomp.initSymbolIterator();var p=function(e){this.map_=new Map;if(e){e=$jscomp.makeIterator(e);for(var k;!(k=e.next()).done;)this.add(k.value)}this.size=this.map_.size};p.prototype.add=function(e){this.map_.set(e,e);this.size=this.map_.size;return this};p.prototype["delete"]=function(e){e=this.map_["delete"](e);this.size=this.map_.size;return e};p.prototype.clear=function(){this.map_.clear();this.size=0};p.prototype.has=function(e){return this.map_.has(e)};p.prototype.entries=
function(){return this.map_.entries()};p.prototype.values=function(){return this.map_.values()};p.prototype[Symbol.iterator]=p.prototype.values;p.prototype.forEach=function(e,k){var h=this;this.map_.forEach(function(p){return e.call(k,p,p,h)})};return p},"es6-impl","es3");
(function(e,p){"function"===typeof define&&define.amd?define([],p):"object"===typeof exports?module.exports=p():e.loki=p()})(this,function(){return function(){function e(a,b){var c,d;if(a===b)return!0;if(!a||!b||!0===a||!0===b||a!==a||b!==b){switch(a){case void 0:c=1;break;case null:c=1;break;case !1:c=3;break;case !0:c=4;break;case "":c=5;break;default:c=a===a?9:0}switch(b){case void 0:d=1;break;case null:d=1;break;case !1:d=3;break;case !0:d=4;break;case "":d=5;break;default:d=b===b?9:0}if(9!==
c||9!==d)return c===d}c=Number(a);d=Number(b);if(c===c||d===d)return c===d;c=a.toString();d=b.toString();return c==d}function p(a,b,c){var d,g;if(!a||!b||!0===a||!0===b||a!==a||b!==b){switch(a){case void 0:d=1;break;case null:d=1;break;case !1:d=3;break;case !0:d=4;break;case "":d=5;break;default:d=a===a?9:0}switch(b){case void 0:g=1;break;case null:g=1;break;case !1:g=3;break;case !0:g=4;break;case "":g=5;break;default:g=b===b?9:0}if(9!==d||9!==g)return d===g?c:d<g}d=Number(a);g=Number(b);if(d===
d&&g===g)return d<g?!0:d>g?!1:c;if(d===d&&g!==g)return!0;if(g===g&&d!==d)return!1;if(a<b)return!0;if(a>b)return!1;if(a==b)return c;d=a.toString();g=b.toString();return d<g?!0:d==g?c:!1}function h(a,b,c){var d,g;if(!a||!b||!0===a||!0===b||a!==a||b!==b){switch(a){case void 0:d=1;break;case null:d=1;break;case !1:d=3;break;case !0:d=4;break;case "":d=5;break;default:d=a===a?9:0}switch(b){case void 0:g=1;break;case null:g=1;break;case !1:g=3;break;case !0:g=4;break;case "":g=5;break;default:g=b===b?9:
0}if(9!==d||9!==g)return d===g?c:d>g}d=Number(a);g=Number(b);if(d===d&&g===g)return d>g?!0:d<g?!1:c;if(d===d&&g!==g)return!1;if(g===g&&d!==d||a>b)return!0;if(a<b)return!1;if(a==b)return c;d=a.toString();g=b.toString();return d>g?!0:d==g?c:!1}function k(a,b,c){return t.aeq(a,b)?0:t.lt(a,b,!1)?c?1:-1:t.gt(a,b,!1)?c?-1:1:0}function z(a,b,c,d,g){g=g||0;var n=b[g],e=!1,l;"object"===typeof a&&n in a&&(l=a[n]);if(g+1>=b.length)e=c(l,d);else if(Array.isArray(l))for(a=0,n=l.length;a<n&&(e=z(l[a],b,c,d,g+1),
!0!==e);a+=1);else e=z(l,b,c,d,g+1);return e}function w(a){return"string"===typeof a||Array.isArray(a)?function(b){return-1!==a.indexOf(b)}:"object"===typeof a&&null!==a?function(b){return C.call(a,b)}:null}function A(a,b){for(var c in b)if(C.call(b,c))return E[c](a,b[c]);return!1}function q(a,b){if(null===a||void 0===a)return null;var c;switch(b||"parse-stringify"){case "parse-stringify":c=JSON.parse(JSON.stringify(a));break;case "jquery-extend-deep":c=jQuery.extend(!0,{},a);break;case "shallow":c=
Object.create(a.constructor.prototype);Object.keys(a).map(function(b){c[b]=a[b]});break;case "shallow-assign":c=Object.create(a.constructor.prototype);Object.assign(c,a);break;case "shallow-recurse-objects":c=q(a,"shallow"),Object.keys(a).forEach(function(b){if("object"===typeof a[b]&&"Object"===a[b].constructor.name)c[b]=q(a[b],"shallow-recurse-objects");else if(Array.isArray(a[b])){var d=c;for(var n=a[b],e=[],l=0,u=n.length;l<u;l++)e[l]=q(n[l],"shallow-recurse-objects");d[b]=e}})}return c}function L(){try{return window&&
void 0!==window.localStorage&&null!==window.localStorage}catch(a){return!1}}function B(){}function m(a,b){this.filename=a||"loki.db";this.collections=[];this.engineVersion=this.databaseVersion=1.5;this.autosave=!1;this.autosaveInterval=5E3;this.autosaveHandle=null;this.throttledSaves=!0;this.options={};this.persistenceAdapter=this.persistenceMethod=null;this.throttledSavePending=!1;this.throttledCallbacks=[];this.verbose=b&&b.hasOwnProperty("verbose")?b.verbose:!1;this.events={init:[],loaded:[],flushChanges:[],
close:[],changes:[],warning:[]};b&&b.hasOwnProperty("env")?this.ENV=b.env:this.ENV="undefined"!==typeof global&&(global.android||global.NSObject)?"NATIVESCRIPT":"undefined"===typeof window||"undefined"!==typeof global&&global.window&&"undefined"!==typeof process?"NODEJS":"undefined"!==typeof document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA";"undefined"===this.ENV&&(this.ENV="NODEJS");this.configureOptions(b,!0);this.on("init",this.clearChanges)}
function H(a){this.hashStore={};this.options=a||{};this.options.hasOwnProperty("asyncResponses")||(this.options.asyncResponses=!1);this.options.hasOwnProperty("asyncTimeout")||(this.options.asyncTimeout=50)}function F(a,b){this.mode="reference";this.adapter=null;this.options=b||{};this.dbref=null;this.dbname="";this.pageIterator={};if(a){if("reference"===a.mode)throw Error("LokiPartitioningAdapter cannot be instantiated with a reference mode adapter");this.adapter=a}else throw Error("LokiPartitioningAdapter requires a (non-reference mode) adapter on construction");
this.options.hasOwnProperty("paging")||(this.options.paging=!1);this.options.hasOwnProperty("pageSize")||(this.options.pageSize=26214400);this.options.hasOwnProperty("delimiter")||(this.options.delimiter="$<\n")}function I(){try{this.fs=require("fs")}catch(a){this.fs=null}}function J(){}function v(a,b){this.collection=a;this.filteredrows=[];this.filterInitialized=!1;return this}function O(a,b){if("$regex"===a)Array.isArray(b)?b=new RegExp(b[0],b[1]):b instanceof RegExp||(b=new RegExp(b));else if("object"===
typeof b)for(var c in b)if("$regex"===c||"object"===typeof b[c])b[c]=O(c,b[c]);return b}function y(a,b,c){this.collection=a;this.name=b;this.rebuildPending=!1;this.options=c||{};this.options.hasOwnProperty("persistent")||(this.options.persistent=!1);this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive");this.options.hasOwnProperty("minRebuildInterval")||(this.options.minRebuildInterval=1);this.resultset=new v(a);this.resultdata=[];this.resultsdirty=!1;this.cachedresultset=
null;this.filterPipeline=[];this.sortCriteriaSimple=this.sortCriteria=this.sortFunction=null;this.sortDirty=!1;this.events={rebuild:[]}}function f(a,b){function c(a,b){var d=null!==b&&"object"===typeof b?Object.keys(b):null;if(d&&d.length&&0>["string","boolean","number"].indexOf(typeof b)){for(var n={},e=0;e<d.length;e++){var x=d[e];if(b.hasOwnProperty(x))if(!a.hasOwnProperty(x)||0<=g.uniqueNames.indexOf(x)||"$loki"==x||"meta"==x)n[x]=b[x];else{var l=c(a[x],b[x]);"undefined"!==typeof l&&l!={}&&(n[x]=
l)}}return 0===Object.keys(n).length?void 0:n}return a===b?void 0:b}function d(){g.changes=[]}this.name=a;this.data=[];this.idIndex=[];this.binaryIndices={};this.constraints={unique:{},exact:{}};this.uniqueNames=[];this.transforms={};this.objType=a;this.dirty=!0;this.cachedData=this.cachedBinaryIndex=this.cachedIndex=null;var g=this;b=b||{};b.hasOwnProperty("unique")&&(Array.isArray(b.unique)||(b.unique=[b.unique]),b.unique.forEach(function(a){g.uniqueNames.push(a);g.constraints.unique[a]=new D(a)}));
b.hasOwnProperty("exact")&&b.exact.forEach(function(a){g.constraints.exact[a]=new Q(a)});this.adaptiveBinaryIndices=b.hasOwnProperty("adaptiveBinaryIndices")?b.adaptiveBinaryIndices:!0;this.transactional=b.hasOwnProperty("transactional")?b.transactional:!1;this.cloneObjects=b.hasOwnProperty("clone")?b.clone:!1;this.cloneMethod=b.hasOwnProperty("cloneMethod")?b.cloneMethod:"parse-stringify";this.asyncListeners=b.hasOwnProperty("asyncListeners")?b.asyncListeners:!1;this.disableMeta=b.hasOwnProperty("disableMeta")?
b.disableMeta:!1;this.disableChangesApi=b.hasOwnProperty("disableChangesApi")?b.disableChangesApi:!0;this.disableDeltaChangesApi=b.hasOwnProperty("disableDeltaChangesApi")?b.disableDeltaChangesApi:!0;this.disableChangesApi&&(this.disableDeltaChangesApi=!0);this.autoupdate=b.hasOwnProperty("autoupdate")?b.autoupdate:!1;this.serializableIndices=b.hasOwnProperty("serializableIndices")?b.serializableIndices:!0;this.ttl={age:null,ttlInterval:null,daemon:null};this.setTTL(b.ttl||-1,b.ttlInterval);this.maxId=
0;this.DynamicViews=[];this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],"delete":[],warning:[]};this.changes=[];this.ensureId();var n=[];if(b&&b.indices)if("[object Array]"===Object.prototype.toString.call(b.indices))n=b.indices;else if("string"===typeof b.indices)n=[b.indices];else throw new TypeError("Indices needs to be a string or an array of strings");for(var e=0;e<n.length;e++)this.ensureIndex(n[e]);this.observerCallback=function(a){var b="function"===
typeof Set?new Set:[];b.add||(b.add=function(a){-1===this.indexOf(a)&&this.push(a);return this});a.forEach(function(a){b.add(a.object)});b.forEach(function(a){if(!C.call(a,"$loki"))return g.removeAutoUpdateObserver(a);try{g.update(a)}catch(K){}})};this.getChangeDelta=function(a,b){return b?c(b,a):JSON.parse(JSON.stringify(a))};this.getObjectDelta=c;this.getChanges=function(){return g.changes};this.flushChanges=d;this.setChangesApi=function(a){g.disableChangesApi=!a;a||(g.disableDeltaChangesApi=!1)};
this.on("delete",function(a){g.disableChangesApi||g.createChange(g.name,"R",a)});this.on("warning",function(a){g.console.warn(a)});d()}function U(a){return parseFloat(a,10)}function V(a,b){return a+b}function W(a,b){return a-b}function M(a){return a.reduce(V,0)/a.length}function X(a){var b=M(a);a=a.map(function(a){a-=b;return a*a});a=M(a);return Math.sqrt(a)}function G(a,b,c){if(!1===c)return a[b];for(b=b.split(".");0<b.length;)a=a[b.shift()];return a}function R(a,b,c){for(var d=0,g=a.length,n,e;d<
g;){e=d+g>>1;n=c.apply(null,[b,a[e]]);if(0===n)return{found:!0,index:e};0>n?g=e:d=e+1}return{found:!1,index:g}}function S(a){return function(b,c){return R(b,c,a)}}function T(){}function D(a){this.field=a;this.keyMap={};this.lokiMap={}}function Q(a){this.index={};this.field=a}var C=Object.prototype.hasOwnProperty,r={copyProperties:function(a,b){for(var c in a)b[c]=a[c]},resolveTransformObject:function(a,b,c){var d,g;"number"!==typeof c&&(c=0);if(10<=++c)return a;for(d in a)"string"===typeof a[d]&&
0===a[d].indexOf("[%lktxp]")?(g=a[d].substring(8),b.hasOwnProperty(g)&&(a[d]=b[g])):"object"===typeof a[d]&&(a[d]=r.resolveTransformObject(a[d],b,c));return a},resolveTransformParams:function(a,b){var c,d,g=[];if("undefined"===typeof b)return a;for(c=0;c<a.length;c++)d=q(a[c],"shallow-recurse-objects"),g.push(r.resolveTransformObject(d,b));return g},getIn:function(a,b,c){if(null!=a){if(!c)return a[b];"string"===typeof b&&(b=b.split("."));if(!Array.isArray(b))throw Error("path must be a string or array. Found "+
typeof b);c=0;for(var d=b.length;null!=a&&c<d;)a=a[b[c++]];return c&&c==d?a:void 0}}},t={aeq:e,lt:p,gt:h},E={$eq:function(a,b){return a===b},$aeq:function(a,b){return a==b},$ne:function(a,b){return b!==b?a===a:a!==b},$dteq:function(a,b){return t.aeq(a,b)},$gt:function(a,b){return t.gt(a,b,!1)},$gte:function(a,b){return t.gt(a,b,!0)},$lt:function(a,b){return t.lt(a,b,!1)},$lte:function(a,b){return t.lt(a,b,!0)},$jgt:function(a,b){return a>b},$jgte:function(a,b){return a>=b},$jlt:function(a,b){return a<
b},$jlte:function(a,b){return a<=b},$between:function(a,b){return void 0===a||null===a?!1:t.gt(a,b[0],!0)&&t.lt(a,b[1],!0)},$jbetween:function(a,b){return void 0===a||null===a?!1:a>=b[0]&&a<=b[1]},$in:function(a,b){return-1!==b.indexOf(a)},$nin:function(a,b){return-1===b.indexOf(a)},$keyin:function(a,b){return a in b},$nkeyin:function(a,b){return!(a in b)},$definedin:function(a,b){return void 0!==b[a]},$undefinedin:function(a,b){return void 0===b[a]},$regex:function(a,b){return b.test(a)},$containsString:function(a,
b){return"string"===typeof a&&-1!==a.indexOf(b)},$containsNone:function(a,b){return!E.$containsAny(a,b)},$containsAny:function(a,b){var c=w(a);return null!==c?Array.isArray(b)?b.some(c):c(b):!1},$contains:function(a,b){var c=w(a);return null!==c?Array.isArray(b)?b.every(c):c(b):!1},$elemMatch:function(a,b){return Array.isArray(a)?a.some(function(a){return Object.keys(b).every(function(c){var d=b[c];"object"===typeof d&&d||(d={$eq:d});return-1!==c.indexOf(".")?z(a,c.split("."),A,b[c]):A(a[c],d)})}):
!1},$type:function(a,b){var c=typeof a;"object"===c&&(Array.isArray(a)?c="array":a instanceof Date&&(c="date"));return"object"!==typeof b?c===b:A(c,b)},$finite:function(a,b){return b===isFinite(a)},$size:function(a,b){return Array.isArray(a)?"object"!==typeof b?a.length===b:A(a.length,b):!1},$len:function(a,b){return"string"===typeof a?"object"!==typeof b?a.length===b:A(a.length,b):!1},$where:function(a,b){return!0===b(a)},$not:function(a,b){return!A(a,b)},$and:function(a,b){for(var c=0,d=b.length;c<
d;c+=1)if(!A(a,b[c]))return!1;return!0},$or:function(a,b){for(var c=0,d=b.length;c<d;c+=1)if(A(a,b[c]))return!0;return!1},$exists:function(a,b){return b?void 0!==a:void 0===a}},N={$eq:E.$eq,$aeq:!0,$dteq:!0,$gt:!0,$gte:!0,$lt:!0,$lte:!0,$in:!0,$between:!0};B.prototype.events={};B.prototype.asyncListeners=!1;B.prototype.on=function(a,b){var c,d=this;if(Array.isArray(a))return a.forEach(function(a){d.on(a,b)}),b;(c=this.events[a])||(c=this.events[a]=[]);c.push(b);return b};B.prototype.emit=function(a){var b=
this,c=Array.prototype.slice.call(arguments,1);if(a&&this.events[a])this.events[a].forEach(function(a){b.asyncListeners?setTimeout(function(){a.apply(b,c)},1):a.apply(b,c)});else throw Error("No event "+a+" defined");};B.prototype.addListener=B.prototype.on;B.prototype.removeListener=function(a,b){var c=this;if(Array.isArray(a))a.forEach(function(a){c.removeListener(a,b)});else if(this.events[a]){var d=this.events[a];d.splice(d.indexOf(b),1)}};m.prototype=new B;m.prototype.constructor=m;m.prototype.getIndexedAdapter=
function(){var a;"function"===typeof require&&(a=require("./loki-indexed-adapter.js"));return a};m.prototype.configureOptions=function(a,b){var c={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage",MEMORY:"memory"},d={fs:I,localStorage:J,memory:H};this.options={};this.persistenceAdapter=this.persistenceMethod=null;if("undefined"!==typeof a){this.options=a;this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof d[a.persistenceMethod]&&(this.persistenceMethod=a.persistenceMethod,
this.persistenceAdapter=new d[a.persistenceMethod]);this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=a.adapter,this.options.adapter=null);if(a.autoload&&b){var g=this;setTimeout(function(){g.loadDatabase(a,a.autoloadCallback)},1)}this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10));this.options.hasOwnProperty("autosave")&&this.options.autosave&&(this.autosaveDisable(),
this.autosave=!0,this.options.hasOwnProperty("autosaveCallback")?this.autosaveEnable(a,a.autosaveCallback):this.autosaveEnable());this.options.hasOwnProperty("throttledSaves")&&(this.throttledSaves=this.options.throttledSaves)}this.options.hasOwnProperty("serializationMethod")||(this.options.serializationMethod="normal");this.options.hasOwnProperty("destructureDelimiter")||(this.options.destructureDelimiter="$<\n");null===this.persistenceAdapter&&(this.persistenceMethod=c[this.ENV])&&(this.persistenceAdapter=
new d[this.persistenceMethod])};m.prototype.copy=function(a){var b=new m(this.filename,{env:"NA"}),c;a=a||{};b.loadJSONObject(this,{retainDirtyFlags:!0});if(a.hasOwnProperty("removeNonSerializable")&&!0===a.removeNonSerializable)for(b.autosaveHandle=null,b.persistenceAdapter=null,a=b.collections.length,c=0;c<a;c++)b.collections[c].constraints=null,b.collections[c].ttl=null;return b};m.prototype.addCollection=function(a,b){var c,d=this.collections.length;if(b&&!0===b.disableMeta){if(!1===b.disableChangesApi)throw Error("disableMeta option cannot be passed as true when disableChangesApi is passed as false");
if(!1===b.disableDeltaChangesApi)throw Error("disableMeta option cannot be passed as true when disableDeltaChangesApi is passed as false");if("number"===typeof b.ttl&&0<b.ttl)throw Error("disableMeta option cannot be passed as true when ttl is enabled");}for(c=0;c<d;c+=1)if(this.collections[c].name===a)return this.collections[c];c=new f(a,b);this.collections.push(c);this.verbose&&(c.console=console);return c};m.prototype.loadCollection=function(a){if(!a.name)throw Error("Collection must have a name property to be loaded");
this.collections.push(a)};m.prototype.getCollection=function(a){var b,c=this.collections.length;for(b=0;b<c;b+=1)if(this.collections[b].name===a)return this.collections[b];this.emit("warning","collection "+a+" not found");return null};m.prototype.renameCollection=function(a,b){var c=this.getCollection(a);c&&(c.name=b);return c};m.prototype.listCollections=function(){for(var a=this.collections.length,b=[];a--;)b.push({name:this.collections[a].name,type:this.collections[a].objType,count:this.collections[a].data.length});
return b};m.prototype.removeCollection=function(a){var b,c=this.collections.length;for(b=0;b<c;b+=1)if(this.collections[b].name===a){a=new f(a,{});var c=this.collections[b],d;for(d in c)c.hasOwnProperty(d)&&a.hasOwnProperty(d)&&(c[d]=a[d]);this.collections.splice(b,1);break}};m.prototype.getName=function(){return this.name};m.prototype.serializeReplacer=function(a,b){switch(a){case "autosaveHandle":case "persistenceAdapter":case "constraints":case "ttl":return null;case "throttledSavePending":case "throttledCallbacks":break;
default:return b}};m.prototype.serialize=function(a){a=a||{};a.hasOwnProperty("serializationMethod")||(a.serializationMethod=this.options.serializationMethod);switch(a.serializationMethod){case "normal":return JSON.stringify(this,this.serializeReplacer);case "pretty":return JSON.stringify(this,this.serializeReplacer,2);case "destructured":return this.serializeDestructured();default:return JSON.stringify(this,this.serializeReplacer)}};m.prototype.toJson=m.prototype.serialize;m.prototype.serializeDestructured=
function(a){var b,c,d,g,n=[];a=a||{};a.hasOwnProperty("partitioned")||(a.partitioned=!1);a.hasOwnProperty("delimited")||(a.delimited=!0);a.hasOwnProperty("delimiter")||(a.delimiter=this.options.destructureDelimiter);if(!0===a.partitioned&&a.hasOwnProperty("partition")&&0<=a.partition)return this.serializeCollection({delimited:a.delimited,delimiter:a.delimiter,collectionIndex:a.partition});c=new m(this.filename);c.loadJSONObject(this);for(b=0;b<c.collections.length;b++)c.collections[b].data=[];if(!0===
a.partitioned&&-1===a.partition)return c.serialize({serializationMethod:"normal"});n.push(c.serialize({serializationMethod:"normal"}));for(b=0;b<this.collections.length;b++)if(d=this.serializeCollection({delimited:a.delimited,delimiter:a.delimiter,collectionIndex:b}),!1===a.partitioned&&!1===a.delimited){if(!Array.isArray(d))throw Error("a nondelimited, non partitioned collection serialization did not return an expected array");g=d.length;for(c=0;c<g;c++)n.push(d[c]),d[c]=null;n.push("")}else n.push(d);
if(a.partitioned)return n;if(a.delimited)return n.push(""),n.join(a.delimiter);n.push("");return n};m.prototype.serializeCollection=function(a){var b,c,d;a=a||{};a.hasOwnProperty("delimited")||(a.delimited=!0);if(!a.hasOwnProperty("collectionIndex"))throw Error("serializeCollection called without 'collectionIndex' option");b=this.collections[a.collectionIndex].data.length;d=[];for(c=0;c<b;c++)d.push(JSON.stringify(this.collections[a.collectionIndex].data[c]));return a.delimited?(d.push(""),d.join(a.delimiter)):
d};m.prototype.deserializeDestructured=function(a,b){var c,d,g=0,n,e=1,l=!1,u;b=b||{};b.hasOwnProperty("partitioned")||(b.partitioned=!1);b.hasOwnProperty("delimited")||(b.delimited=!0);b.hasOwnProperty("delimiter")||(b.delimiter=this.options.destructureDelimiter);if(b.partitioned){if(b.hasOwnProperty("partition"))return-1===b.partition?d=JSON.parse(a[0]):this.deserializeCollection(a[b.partition+1],b);d=JSON.parse(a[0]);n=d.collections.length;for(g=0;g<n;g++)d.collections[g].data=this.deserializeCollection(a[g+
1],b);return d}if(b.delimited){if(c=a.split(b.delimiter),d=c.length,0===d)return null}else c=a;d=JSON.parse(c[0]);n=d.collections.length;for(c[0]=null;!l;)""===c[e]?++g>n&&(l=!0):(u=JSON.parse(c[e]),d.collections[g].data.push(u)),c[e++]=null;return d};m.prototype.deserializeCollection=function(a,b){var c,d,g;b=b||{};b.hasOwnProperty("partitioned")||(b.partitioned=!1);b.hasOwnProperty("delimited")||(b.delimited=!0);b.hasOwnProperty("delimiter")||(b.delimiter=this.options.destructureDelimiter);b.delimited?
(c=a.split(b.delimiter),c.pop()):c=a;g=c.length;for(d=0;d<g;d++)c[d]=JSON.parse(c[d]);return c};m.prototype.loadJSON=function(a,b){var c;if(0===a.length)c={};else switch(this.options.serializationMethod){case "normal":case "pretty":c=JSON.parse(a);break;case "destructured":c=this.deserializeDestructured(a);break;default:c=JSON.parse(a)}this.loadJSONObject(c,b)};m.prototype.loadJSONObject=function(a,b){function c(a){var c=b[a.name],d;return c.proto?(d=c.inflate||r.copyProperties,function(a){var b=
new c.proto;d(a,b);return b}):c.inflate}var d=0,g=a.collections?a.collections.length:0,n,e,l,u,f,k;this.name=a.name;a.hasOwnProperty("throttledSaves")&&b&&!b.hasOwnProperty("throttledSaves")&&(this.throttledSaves=a.throttledSaves);this.collections=[];for(d;d<g;d+=1){n=a.collections[d];e=this.addCollection(n.name,{disableChangesApi:n.disableChangesApi,disableDeltaChangesApi:n.disableDeltaChangesApi,disableMeta:n.disableMeta});e.adaptiveBinaryIndices=n.hasOwnProperty("adaptiveBinaryIndices")?!0===n.adaptiveBinaryIndices:
!1;e.transactional=n.transactional;e.asyncListeners=n.asyncListeners;e.cloneObjects=n.cloneObjects;e.cloneMethod=n.cloneMethod||"parse-stringify";e.autoupdate=n.autoupdate;e.changes=n.changes;e.dirty=b&&!0===b.retainDirtyFlags?n.dirty:!1;l=n.data.length;u=0;if(b&&b.hasOwnProperty(n.name))for(f=c(n),u;u<l;u++)k=f(n.data[u]),e.data[u]=k,e.addAutoUpdateObserver(k);else for(u;u<l;u++)e.data[u]=n.data[u],e.addAutoUpdateObserver(e.data[u]);e.maxId="undefined"===typeof n.maxId?0:n.maxId;e.idIndex=n.idIndex;
"undefined"!==typeof n.binaryIndices&&(e.binaryIndices=n.binaryIndices);"undefined"!==typeof n.transforms&&(e.transforms=n.transforms);e.ensureId();e.uniqueNames=[];if(n.hasOwnProperty("uniqueNames"))for(e.uniqueNames=n.uniqueNames,u=0;u<e.uniqueNames.length;u++)e.ensureUniqueIndex(e.uniqueNames[u]);if("undefined"!==typeof n.DynamicViews){for(l=0;l<n.DynamicViews.length;l++)u=n.DynamicViews[l],f=e.addDynamicView(u.name,u.options),f.resultdata=u.resultdata,f.resultsdirty=u.resultsdirty,f.filterPipeline=
u.filterPipeline,f.sortCriteria=u.sortCriteria,f.sortFunction=null,f.sortDirty=u.sortDirty,f.resultset.filteredrows=u.resultset.filteredrows,f.resultset.filterInitialized=u.resultset.filterInitialized,f.rematerialize({removeWhereFilters:!0});1.5>a.databaseVersion&&(e.ensureAllIndexes(!0),e.dirty=!0)}}};m.prototype.close=function(a){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(this.saveDatabase(a),a=void 0));if(a)this.on("close",a);this.emit("close")};m.prototype.generateChangesNotification=
function(a){function b(a){return a.name}var c=[],d=a||this.collections.map(b);this.collections.forEach(function(a){-1!==d.indexOf(a.name)&&(c=c.concat(a.getChanges()))});return c};m.prototype.serializeChanges=function(a){return JSON.stringify(this.generateChangesNotification(a))};m.prototype.clearChanges=function(){this.collections.forEach(function(a){a.flushChanges&&a.flushChanges()})};H.prototype.loadDatabase=function(a,b){var c=this;this.options.asyncResponses?setTimeout(function(){c.hashStore.hasOwnProperty(a)?
b(c.hashStore[a].value):b(null)},this.options.asyncTimeout):this.hashStore.hasOwnProperty(a)?b(this.hashStore[a].value):b(null)};H.prototype.saveDatabase=function(a,b,c){var d=this,g;this.options.asyncResponses?setTimeout(function(){g=d.hashStore.hasOwnProperty(a)?d.hashStore[a].savecount:0;d.hashStore[a]={savecount:g+1,lastsave:new Date,value:b};c()},this.options.asyncTimeout):(g=this.hashStore.hasOwnProperty(a)?this.hashStore[a].savecount:0,this.hashStore[a]={savecount:g+1,lastsave:new Date,value:b},
c())};H.prototype.deleteDatabase=function(a,b){this.hashStore.hasOwnProperty(a)&&delete this.hashStore[a];"function"===typeof b&&b()};F.prototype.loadDatabase=function(a,b){var c=this;this.dbname=a;this.dbref=new m(a);this.adapter.loadDatabase(a,function(a){a?("string"!==typeof a&&b(Error("LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()")),a=JSON.parse(a),c.dbref.loadJSONObject(a),a=null,0===c.dbref.collections.length?b(c.dbref):(c.pageIterator={collection:0,
pageIndex:0},c.loadNextPartition(0,function(){b(c.dbref)}))):b(a)})};F.prototype.loadNextPartition=function(a,b){var c=this.dbname+"."+a,d=this;!0===this.options.paging?(this.pageIterator.pageIndex=0,this.loadNextPage(b)):this.adapter.loadDatabase(c,function(c){c=d.dbref.deserializeCollection(c,{delimited:!0,collectionIndex:a});d.dbref.collections[a].data=c;++a<d.dbref.collections.length?d.loadNextPartition(a,b):b()})};F.prototype.loadNextPage=function(a){var b=this;this.adapter.loadDatabase(this.dbname+
"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,function(c){c=c.split(b.options.delimiter);var d=c.length,g,n=""===c[d-1];n&&(c.pop(),d=c.length,""===c[d-1]&&1===d&&(c.pop(),d=c.length));for(g=0;g<d;g++)b.dbref.collections[b.pageIterator.collection].data.push(JSON.parse(c[g])),c[g]=null;n?++b.pageIterator.collection<b.dbref.collections.length?b.loadNextPartition(b.pageIterator.collection,a):a():(b.pageIterator.pageIndex++,b.loadNextPage(a))})};F.prototype.exportDatabase=function(a,
b,c){var d=b.collections.length;this.dbref=b;this.dbname=a;this.dirtyPartitions=[-1];for(a=0;a<d;a++)b.collections[a].dirty&&this.dirtyPartitions.push(a);this.saveNextPartition(function(a){c(a)})};F.prototype.saveNextPartition=function(a){var b=this,c=this.dirtyPartitions.shift(),d=this.dbname+(-1===c?"":"."+c);this.options.paging&&-1!==c?(this.pageIterator={collection:c,docIndex:0,pageIndex:0},this.saveNextPage(function(c){0===b.dirtyPartitions.length?a(c):b.saveNextPartition(a)})):(c=this.dbref.serializeDestructured({partitioned:!0,
delimited:!0,partition:c}),this.adapter.saveDatabase(d,c,function(c){c?a(c):0===b.dirtyPartitions.length?a(null):b.saveNextPartition(a)}))};F.prototype.saveNextPage=function(a){var b=this,c=this.dbref.collections[this.pageIterator.collection],d=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,g=0,n=c.data.length,e=this.options.delimiter.length,l="",u="",f=!1,k=!1,h=function(c){u="";c&&a(c);f?a(null):(b.pageIterator.pageIndex++,b.saveNextPage(a))};for(0===c.data.length&&
(f=!0);;){f||(l=JSON.stringify(c.data[this.pageIterator.docIndex]),u+=l,g+=l.length,++this.pageIterator.docIndex>=n&&(f=!0));g>=this.options.pageSize&&(k=!0);if(!k||f)u+=this.options.delimiter,g+=e;if(f||k){this.adapter.saveDatabase(d,u,h);break}}};I.prototype.loadDatabase=function(a,b){var c=this;this.fs.stat(a,function(d,g){!d&&g.isFile()?c.fs.readFile(a,{encoding:"utf8"},function(a,c){a?b(Error(a)):b(c)}):b(null)})};I.prototype.saveDatabase=function(a,b,c){var d=this,g=a+"~";this.fs.writeFile(g,
b,function(b){b?c(Error(b)):d.fs.rename(g,a,c)})};I.prototype.deleteDatabase=function(a,b){this.fs.unlink(a,function(a){a?b(Error(a)):b()})};J.prototype.loadDatabase=function(a,b){L()?b(localStorage.getItem(a)):b(Error("localStorage is not available"))};J.prototype.saveDatabase=function(a,b,c){L()?(localStorage.setItem(a,b),c(null)):c(Error("localStorage is not available"))};J.prototype.deleteDatabase=function(a,b){L()?(localStorage.removeItem(a),b(null)):b(Error("localStorage is not available"))};
m.prototype.throttledSaveDrain=function(a,b){var c=this,d=(new Date).getTime();this.throttledSaves||a(!0);b=b||{};b.hasOwnProperty("recursiveWait")||(b.recursiveWait=!0);b.hasOwnProperty("recursiveWaitLimit")||(b.recursiveWaitLimit=!1);b.hasOwnProperty("recursiveWaitLimitDuration")||(b.recursiveWaitLimitDuration=2E3);b.hasOwnProperty("started")||(b.started=(new Date).getTime());this.throttledSaves&&this.throttledSavePending?b.recursiveWait?this.throttledCallbacks.push(function(){c.throttledSavePending?
b.recursiveWaitLimit&&d-b.started>b.recursiveWaitLimitDuration?a(!1):c.throttledSaveDrain(a,b):a(!0)}):this.throttledCallbacks.push(a):a(!0)};m.prototype.loadDatabaseInternal=function(a,b){var c=b||function(a,b){if(a)throw a;},d=this;null!==this.persistenceAdapter?this.persistenceAdapter.loadDatabase(this.filename,function(b){if("string"===typeof b){var g=!1;try{d.loadJSON(b,a||{}),g=!0}catch(x){c(x)}g&&(c(null),d.emit("loaded","database "+d.filename+" loaded"))}else b?b instanceof Error?c(b):"object"===
typeof b?(d.loadJSONObject(b,a||{}),c(null),d.emit("loaded","database "+d.filename+" loaded")):c("unexpected adapter response : "+b):(c(null),d.emit("loaded","empty database "+d.filename+" loaded"))}):c(Error("persistenceAdapter not configured"))};m.prototype.loadDatabase=function(a,b){var c=this;this.throttledSaves?this.throttledSaveDrain(function(d){d?(c.throttledSavePending=!0,c.loadDatabaseInternal(a,function(a){0===c.throttledCallbacks.length?c.throttledSavePending=!1:c.saveDatabase();"function"===
typeof b&&b(a)})):"function"===typeof b&&b(Error("Unable to pause save throttling long enough to read database"))},a):this.loadDatabaseInternal(a,b)};m.prototype.saveDatabaseInternal=function(a){var b=a||function(a){if(a)throw a;},c=this;null!==this.persistenceAdapter?"reference"===this.persistenceAdapter.mode&&"function"===typeof this.persistenceAdapter.exportDatabase?this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:!0}),function(a){c.autosaveClearFlags();b(a)}):
(c.autosaveClearFlags(),this.persistenceAdapter.saveDatabase(this.filename,c.serialize(),function(a){b(a)})):b(Error("persistenceAdapter not configured"))};m.prototype.saveDatabase=function(a){if(this.throttledSaves)if(this.throttledSavePending)this.throttledCallbacks.push(a);else{var b=this.throttledCallbacks;this.throttledCallbacks=[];b.unshift(a);this.throttledSavePending=!0;var c=this;this.saveDatabaseInternal(function(a){c.throttledSavePending=!1;b.forEach(function(b){"function"===typeof b&&
setTimeout(function(){b(a)},1)});0<c.throttledCallbacks.length&&c.saveDatabase()})}else this.saveDatabaseInternal(a)};m.prototype.save=m.prototype.saveDatabase;m.prototype.deleteDatabase=function(a,b){var c=b||function(a,b){if(a)throw a;};"function"!==typeof a||b||(c=a);null!==this.persistenceAdapter?this.persistenceAdapter.deleteDatabase(this.filename,function(a){c(a)}):c(Error("persistenceAdapter not configured"))};m.prototype.autosaveDirty=function(){for(var a=0;a<this.collections.length;a++)if(this.collections[a].dirty)return!0;
return!1};m.prototype.autosaveClearFlags=function(){for(var a=0;a<this.collections.length;a++)this.collections[a].dirty=!1};m.prototype.autosaveEnable=function(a,b){this.autosave=!0;var c=5E3,d=this;"undefined"!==typeof this.autosaveInterval&&null!==this.autosaveInterval&&(c=this.autosaveInterval);this.autosaveHandle=setInterval(function(){d.autosaveDirty()&&d.saveDatabase(b)},c)};m.prototype.autosaveDisable=function(){"undefined"!==typeof this.autosaveHandle&&null!==this.autosaveHandle&&(clearInterval(this.autosaveHandle),
this.autosaveHandle=null)};v.prototype.reset=function(){0<this.filteredrows.length&&(this.filteredrows=[]);this.filterInitialized=!1;return this};v.prototype.toJSON=function(){var a=this.copy();a.collection=null;return a};v.prototype.limit=function(a){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var b=new v(this.collection);b.filteredrows=this.filteredrows.slice(0,a);b.filterInitialized=!0;return b};v.prototype.offset=function(a){this.filterInitialized||
0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var b=new v(this.collection);b.filteredrows=this.filteredrows.slice(a);b.filterInitialized=!0;return b};v.prototype.copy=function(){var a=new v(this.collection);0<this.filteredrows.length&&(a.filteredrows=this.filteredrows.slice());a.filterInitialized=this.filterInitialized;return a};v.prototype.branch=v.prototype.copy;v.prototype.transform=function(a,b){var c,d,g=this;"string"===typeof a&&this.collection.transforms.hasOwnProperty(a)&&
(a=this.collection.transforms[a]);if("object"!==typeof a||!Array.isArray(a))throw Error("Invalid transform");"undefined"!==typeof b&&(a=r.resolveTransformParams(a,b));for(c=0;c<a.length;c++)switch(d=a[c],d.type){case "find":g.find(d.value);break;case "where":g.where(d.value);break;case "simplesort":g.simplesort(d.property,d.desc||d.options);break;case "compoundsort":g.compoundsort(d.value);break;case "sort":g.sort(d.value);break;case "limit":g=g.limit(d.value);break;case "offset":g=g.offset(d.value);
break;case "map":g=g.map(d.value,d.dataOptions);break;case "eqJoin":g=g.eqJoin(d.joinData,d.leftJoinKey,d.rightJoinKey,d.mapFun,d.dataOptions);break;case "mapReduce":g=g.mapReduce(d.mapFunction,d.reduceFunction);break;case "update":g.update(d.value);break;case "remove":g.remove()}return g};v.prototype.sort=function(a){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());a=function(a,c){return function(b,g){return a(c[b],c[g])}}(a,this.collection.data);
this.filteredrows.sort(a);return this};v.prototype.simplesort=function(a,b){var c=10,d=this.collection.data.length,g=this.filteredrows.length,n=this.collection.binaryIndices.hasOwnProperty(a);if("undefined"===typeof b||!1===b)b={desc:!1};!0===b&&(b={desc:!0});if(0===g){if(this.filterInitialized)return this;if(this.collection.binaryIndices.hasOwnProperty(a))return this.collection.ensureIndex(a),this.filteredrows=this.collection.binaryIndices[a].values.slice(0),b.desc&&this.filteredrows.reverse(),this;
this.filteredrows=this.collection.prepareFullDocIndex()}else if(!b.disableIndexIntersect&&n&&(b.useJavascriptSorting&&(c=6),d/g<=c||b.forceIndexIntersect)){for(var d=this.filteredrows,e={},c=0;c<g;c++)e[d[c]]=!0;this.filteredrows=this.collection.binaryIndices[a].values.filter(function(a){return e[a]});b.desc&&this.filteredrows.reverse();return this}if(b.useJavascriptSorting)return this.sort(function(b,c){if(b[a]===c[a])return 0;if(b[a]>c[a])return 1;if(b[a]<c[a])return-1});g=function(a,b,c){var d,
g,e;return function(n,l){~a.indexOf(".")?(e=a.split("."),d=r.getIn(c[n],e,!0),g=r.getIn(c[l],e,!0)):(d=c[n][a],g=c[l][a]);return k(d,g,b)}}(a,b.desc,this.collection.data);this.filteredrows.sort(g);return this};v.prototype.compoundsort=function(a){if(0===a.length)throw Error("Invalid call to compoundsort, need at least one property");var b;if(1===a.length)return b=a[0],Array.isArray(b)?this.simplesort(b[0],b[1]):this.simplesort(b,!1);for(var c=0,d=a.length;c<d;c+=1)b=a[c],Array.isArray(b)||(a[c]=[b,
!1]);this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());a=function(a,b){return function(c,d){var g;a:{g=b[c];for(var e=b[d],n,l,x,f=0,h=a.length;f<h;f++)if(n=a[f],l=n[0],~l.indexOf(".")?(l=l.split("."),x=r.getIn(g,l,!0),l=r.getIn(e,l,!0)):(x=g[l],l=e[l]),n=k(x,l,n[1]),0!==n){g=n;break a}g=0}return g}}(a,this.collection.data);this.filteredrows.sort(a);return this};v.prototype.findOr=function(a){for(var b,c,d,g=[],e=[],x,l=this.count(),f=
0,k=a.length;f<k;f++){b=this.branch().find(a[f]).filteredrows;d=b.length;if(d===l)return this;for(c=0;c<d;c++)x=b[c],void 0===e[x]&&(e[x]=!0,g.push(x))}this.filteredrows=g;this.filterInitialized=!0;return this};v.prototype.$or=v.prototype.findOr;v.prototype.findAnd=function(a){for(var b=0,c=a.length;b<c&&0!==this.count();b++)this.find(a[b]);return this};v.prototype.$and=v.prototype.findAnd;v.prototype.find=function(a,b){if(0===this.collection.data.length)return this.filteredrows=[],this.filterInitialized=
!0,this;var c=a||"getAll",d,g,e,x,l,f,k,h=!1,m=[],q=[],p=null;b=b||!1;if("object"===typeof c){for(d in c)x={},x[d]=c[d],q.push(x),C.call(c,d)&&(g=d,e=c[d]);if(1<q.length)return this.find({$and:q},b)}if(!g||"getAll"===c)return b&&(this.filterInitialized?this.filteredrows=this.filteredrows.slice(0,1):(this.filteredrows=0<this.collection.data.length?[0]:[],this.filterInitialized=!0)),this;if("$and"===g||"$or"===g)return this[g](e),b&&1<this.filteredrows.length&&(this.filteredrows=this.filteredrows.slice(0,
1)),this;if(null===e||"object"!==typeof e||e instanceof Date)l="$eq",f=e;else if("object"===typeof e)for(k in e){if(C.call(e,k)){l=k;f=e[k];break}}else throw Error("Do not know what you want to do.");if("$regex"===l||"object"===typeof f)f=O(l,f);d=-1!==g.indexOf(".");!this.filterInitialized&&this.collection.binaryIndices[g]&&N[l]&&(!0!==this.collection.adaptiveBinaryIndices&&this.collection.ensureIndex(g),h=!0,p=this.collection.binaryIndices[g]);e=E[l];c=this.collection.data;if(this.filterInitialized)if(p=
this.filteredrows,l=p.length,d)for(g=g.split("."),h=0;h<l;h++){if(d=p[h],z(c[d],g,e,f)&&(m.push(d),b))return this.filteredrows=m,this}else for(h=0;h<l;h++){if(d=p[h],e(c[d][g],f)&&(m.push(d),b))return this.filteredrows=m,this}else if(h)if(e=this.collection.calculateRange(l,g,f),"$in"!==l)for(h=e[0];h<=e[1];h++)if(!0!==N[l]){if(N[l](r.getIn(c[p.values[h]],g,d),f)&&(m.push(p.values[h]),b))return this.filteredrows=m,this.filterInitialized=!0,this}else{if(m.push(p.values[h]),b)return this.filteredrows=
m,this.filterInitialized=!0,this}else for(h=0,l=e.length;h<l;h++){if(m.push(p.values[e[h]]),b)return this.filteredrows=m,this.filterInitialized=!0,this}else if(l=c.length,d)for(g=g.split("."),h=0;h<l;h++){if(z(c[h],g,e,f)&&(m.push(h),b))return this.filteredrows=m,this.filterInitialized=!0,this}else for(h=0;h<l;h++)if(e(c[h][g],f)&&(m.push(h),b))return this.filteredrows=m,this.filterInitialized=!0,this;this.filteredrows=m;this.filterInitialized=!0;return this};v.prototype.where=function(a){var b=[];
if("function"!==typeof a)throw new TypeError("Argument is not a stored view or a function");try{if(this.filterInitialized){for(var c=this.filteredrows.length;c--;)!0===a(this.collection.data[this.filteredrows[c]])&&b.push(this.filteredrows[c]);this.filteredrows=b}else{for(var d=this.collection.data.length;d--;)!0===a(this.collection.data[d])&&b.push(d);this.filteredrows=b;this.filterInitialized=!0}return this}catch(g){throw g;}};v.prototype.count=function(){return this.filterInitialized?this.filteredrows.length:
this.collection.count()};v.prototype.data=function(a){var b=[],c=this.collection.data,d,g,e,f;a=a||{};a.removeMeta&&!a.forceClones&&(a.forceClones=!0,a.forceCloneMethod=a.forceCloneMethod||"shallow");this.collection.disableDeltaChangesApi||(a.forceClones=!0,a.forceCloneMethod="parse-stringify");if(!this.filterInitialized){if(0===this.filteredrows.length){if(this.collection.cloneObjects||a.forceClones){g=c.length;f=a.forceCloneMethod||this.collection.cloneMethod;for(e=0;e<g;e++)d=q(c[e],f),a.removeMeta&&
(delete d.$loki,delete d.meta),b.push(d);return b}return c.slice()}this.filterInitialized=!0}var l=this.filteredrows;g=l.length;if(this.collection.cloneObjects||a.forceClones)for(f=a.forceCloneMethod||this.collection.cloneMethod,e=0;e<g;e++)d=q(c[l[e]],f),a.removeMeta&&(delete d.$loki,delete d.meta),b.push(d);else for(e=0;e<g;e++)b.push(c[l[e]]);return b};v.prototype.update=function(a){if("function"!==typeof a)throw new TypeError("Argument is not a function");this.filterInitialized||0!==this.filteredrows.length||
(this.filteredrows=this.collection.prepareFullDocIndex());for(var b,c=this.filteredrows.length,d=this.collection.data,g=0;g<c;g++)this.collection.cloneObjects||!this.collection.disableDeltaChangesApi?(b=q(d[this.filteredrows[g]],this.collection.cloneMethod),a(b),this.collection.update(b)):(a(d[this.filteredrows[g]]),this.collection.update(d[this.filteredrows[g]]));return this};v.prototype.remove=function(){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());
this.collection.removeBatchByPositions(this.filteredrows);this.filteredrows=[];return this};v.prototype.mapReduce=function(a,b){try{return b(this.data().map(a))}catch(c){throw c;}};v.prototype.eqJoin=function(a,b,c,d,g){var e=[],x,l=[],h=[],k="function"===typeof b,m="function"===typeof c,p={},e=this.data(g);x=e.length;if(a instanceof f)l=a.chain().data(g);else if(a instanceof v)l=a.data(g);else if(Array.isArray(a))l=a;else throw new TypeError("joinData needs to be an array or result set");g=l.length;
for(var q=0;q<g;q++)a=m?c(l[q]):l[q][c],p[a]=l[q];d||(d=function(a,b){return{left:a,right:b}});for(c=0;c<x;c++)a=k?b(e[c]):e[c][b],h.push(d(e[c],p[a]||{}));this.collection=new f("joinData");this.collection.insert(h);this.filteredrows=[];this.filterInitialized=!1;return this};v.prototype.map=function(a,b){var c=this.data(b).map(a);this.collection=new f("mappedData");this.collection.insert(c);this.filteredrows=[];this.filterInitialized=!1;return this};y.prototype=new B;y.prototype.rematerialize=function(a){var b;
a=a||{};this.resultdata=[];this.resultsdirty=!0;this.resultset=new v(this.collection);if(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple)this.sortDirty=!0;if(a.hasOwnProperty("removeWhereFilters"))for(a=this.filterPipeline.length;a--;)"where"===this.filterPipeline[a].type&&(a!==this.filterPipeline.length-1&&(this.filterPipeline[a]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var c=this.filterPipeline;this.filterPipeline=[];a=c.length;for(b=0;b<a;b++)this.applyFind(c[b].val);
this.data();this.emit("rebuild",this);return this};y.prototype.branchResultset=function(a,b){var c=this.resultset.branch();return"undefined"===typeof a?c:c.transform(a,b)};y.prototype.toJSON=function(){var a=new y(this.collection,this.name,this.options);a.resultset=this.resultset;a.resultdata=[];a.resultsdirty=!0;a.filterPipeline=this.filterPipeline;a.sortFunction=this.sortFunction;a.sortCriteria=this.sortCriteria;a.sortCriteriaSimple=this.sortCriteriaSimple||null;a.sortDirty=this.sortDirty;a.collection=
null;return a};y.prototype.removeFilters=function(a){a=a||{};this.rebuildPending=!1;this.resultset.reset();this.resultdata=[];this.resultsdirty=!0;this.cachedresultset=null;this.filterPipeline=[];this.sortCriteriaSimple=this.sortCriteria=this.sortFunction=null;this.sortDirty=!1;!0===a.queueSortPhase&&this.queueSortPhase()};y.prototype.applySort=function(a){this.sortFunction=a;this.sortCriteriaSimple=this.sortCriteria=null;this.queueSortPhase();return this};y.prototype.applySimpleSort=function(a,b){this.sortCriteriaSimple=
{propname:a,options:b||!1};this.sortFunction=this.sortCriteria=null;this.queueSortPhase();return this};y.prototype.applySortCriteria=function(a){this.sortCriteria=a;this.sortFunction=this.sortCriteriaSimple=null;this.queueSortPhase();return this};y.prototype.startTransaction=function(){this.cachedresultset=this.resultset.copy();return this};y.prototype.commit=function(){this.cachedresultset=null;return this};y.prototype.rollback=function(){this.resultset=this.cachedresultset;this.options.persistent&&
(this.resultdata=this.resultset.data(),this.emit("rebuild",this));return this};y.prototype._indexOfFilterWithId=function(a){if("string"===typeof a||"number"===typeof a)for(var b=0,c=this.filterPipeline.length;b<c;b+=1)if(a===this.filterPipeline[b].uid)return b;return-1};y.prototype._addFilter=function(a){this.filterPipeline.push(a);this.resultset[a.type](a.val)};y.prototype.reapplyFilters=function(){this.resultset.reset();this.cachedresultset=null;this.options.persistent&&(this.resultdata=[],this.resultsdirty=
!0);var a=this.filterPipeline;this.filterPipeline=[];for(var b=0,c=a.length;b<c;b+=1)this._addFilter(a[b]);this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent();return this};y.prototype.applyFilter=function(a){var b=this._indexOfFilterWithId(a.uid);if(0<=b)return this.filterPipeline[b]=a,this.reapplyFilters();this.cachedresultset=null;this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);this._addFilter(a);this.sortFunction||this.sortCriteria||
this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent();return this};y.prototype.applyFind=function(a,b){this.applyFilter({type:"find",val:a,uid:b});return this};y.prototype.applyWhere=function(a,b){this.applyFilter({type:"where",val:a,uid:b});return this};y.prototype.removeFilter=function(a){var b=this._indexOfFilterWithId(a);if(0>b)throw Error("Dynamic view does not contain a filter with ID: "+a);this.filterPipeline.splice(b,1);this.reapplyFilters();return this};y.prototype.count=
function(){this.resultsdirty&&(this.resultdata=this.resultset.data());return this.resultset.count()};y.prototype.data=function(a){(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0});return this.options.persistent?this.resultdata:this.resultset.data(a)};y.prototype.queueRebuildEvent=function(){if(!this.rebuildPending){this.rebuildPending=!0;var a=this;setTimeout(function(){a.rebuildPending&&(a.rebuildPending=!1,a.emit("rebuild",a))},this.options.minRebuildInterval)}};
y.prototype.queueSortPhase=function(){if(!this.sortDirty){this.sortDirty=!0;var a=this;"active"===this.options.sortPriority?setTimeout(function(){a.performSortPhase()},this.options.minRebuildInterval):this.queueRebuildEvent()}};y.prototype.performSortPhase=function(a){if(this.sortDirty||this.resultsdirty)a=a||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria?this.resultset.compoundsort(this.sortCriteria):this.sortCriteriaSimple&&this.resultset.simplesort(this.sortCriteriaSimple.propname,
this.sortCriteriaSimple.options),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),a.suppressRebuildEvent||this.emit("rebuild",this)};y.prototype.evaluateDocument=function(a,b){if(this.resultset.filterInitialized){var c=this.resultset.filteredrows,d=b?-1:c.indexOf(+a),g=c.length,e=new v(this.collection);e.filteredrows=[a];e.filterInitialized=!0;for(var f,l=0,h=this.filterPipeline.length;l<h;l++)f=this.filterPipeline[l],e[f.type](f.val);e=0===
e.filteredrows.length?-1:0;if(-1!==d||-1!==e)-1===d&&-1!==e?(c.push(a),this.options.persistent&&this.resultdata.push(this.collection.data[a]),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent()):-1!==d&&-1===e?(d<g-1?(c.splice(d,1),this.options.persistent&&this.resultdata.splice(d,1)):(c.length=g-1,this.options.persistent&&(this.resultdata.length=g-1)),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent()):
-1!==d&&-1!==e&&(this.options.persistent&&(this.resultdata[d]=this.collection.data[a]),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())}else this.options.persistent&&(this.resultdata=this.resultset.data()),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent()};y.prototype.removeDocument=function(a){var b,c,d={},g={},e=[],f=this.resultset,e=this.resultset.filteredrows,l=e.length;if(this.resultset.filterInitialized){Array.isArray(a)||
(a=[a]);c=a.length;for(b=0;b<c;b++)d[a[b]]=!0;for(b=0;b<l;b++)d[e[b]]&&(g[b]=!0);0<Object.keys(g).length&&(this.resultset.filteredrows=this.resultset.filteredrows.filter(function(a,b){return!g[b]}),this.options.persistent&&(this.resultdata=this.resultdata.filter(function(a,b){return!g[b]})),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());d=function(a){return function(b){return b<f.filteredrows[a]}};l=f.filteredrows.length;for(b=0;b<l;b++)e=
a.filter(d(b)),f.filteredrows[b]-=e.length}else this.options.persistent&&(this.resultdata=this.resultset.data()),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent()};y.prototype.mapReduce=function(a,b){try{return b(this.data().map(a))}catch(c){throw c;}};f.prototype=new B;f.prototype.createChange=function(a,b,c,d){this.changes.push({name:a,operation:b,obj:"U"!=b||this.disableDeltaChangesApi?JSON.parse(JSON.stringify(c)):this.getChangeDelta(c,
d)})};f.prototype.insertMeta=function(a){var b,c;if(!this.disableMeta&&a)if(Array.isArray(a))for(b=a.length,c=0;c<b;c++)a[c].hasOwnProperty("meta")||(a[c].meta={}),a[c].meta.created=(new Date).getTime(),a[c].meta.revision=0;else a.meta||(a.meta={}),a.meta.created=(new Date).getTime(),a.meta.revision=0};f.prototype.updateMeta=function(a){!this.disableMeta&&a&&(a.meta.updated=(new Date).getTime(),a.meta.revision+=1)};f.prototype.createInsertChange=function(a){this.createChange(this.name,"I",a)};f.prototype.createUpdateChange=
function(a,b){this.createChange(this.name,"U",a,b)};f.prototype.insertMetaWithChange=function(a){this.insertMeta(a);this.createInsertChange(a)};f.prototype.updateMetaWithChange=function(a,b){this.updateMeta(a);this.createUpdateChange(a,b)};f.prototype.console={log:function(){},warn:function(){},error:function(){}};f.prototype.addAutoUpdateObserver=function(a){this.autoupdate&&"function"===typeof Object.observe&&Object.observe(a,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])};
f.prototype.removeAutoUpdateObserver=function(a){this.autoupdate&&"function"===typeof Object.observe&&Object.unobserve(a,this.observerCallback)};f.prototype.addTransform=function(a,b){if(this.transforms.hasOwnProperty(a))throw Error("a transform by that name already exists");this.transforms[a]=b};f.prototype.getTransform=function(a){return this.transforms[a]};f.prototype.setTransform=function(a,b){this.transforms[a]=b};f.prototype.removeTransform=function(a){delete this.transforms[a]};f.prototype.byExample=
function(a){var b,c,d;d=[];for(b in a)a.hasOwnProperty(b)&&d.push((c={},c[b]=a[b],c));return{$and:d}};f.prototype.findObject=function(a){return this.findOne(this.byExample(a))};f.prototype.findObjects=function(a){return this.find(this.byExample(a))};f.prototype.ttlDaemonFuncGen=function(){var a=this,b=this.ttl.age;return function(){var c=Date.now();a.chain().where(function(a){return b<c-(a.meta.updated||a.meta.created)}).remove()}};f.prototype.setTTL=function(a,b){0>a?clearInterval(this.ttl.daemon):
(this.ttl.age=a,this.ttl.ttlInterval=b,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),b))};f.prototype.prepareFullDocIndex=function(){for(var a=this.data.length,b=Array(a),c=0;c<a;c+=1)b[c]=c;return b};f.prototype.configureOptions=function(a){a=a||{};a.hasOwnProperty("adaptiveBinaryIndices")&&(this.adaptiveBinaryIndices=a.adaptiveBinaryIndices)&&this.ensureAllIndexes()};f.prototype.ensureIndex=function(a,b){"undefined"===typeof b&&(b=!1);if(null===a||void 0===a)throw Error("Attempting to set index without an associated property");
if(!this.binaryIndices[a]||b||this.binaryIndices[a].dirty)if(!0!==this.adaptiveBinaryIndices||!this.binaryIndices.hasOwnProperty(a)||b){var c={name:a,dirty:!0,values:this.prepareFullDocIndex()};this.binaryIndices[a]=c;var d=function(a,b){var c,d,g;return function(e,n){~a.indexOf(".")?(g=a.split("."),c=r.getIn(b[e],g,!0),d=r.getIn(b[n],g,!0)):(c=b[e][a],d=b[n][a]);if(c!==d){if(t.lt(c,d,!1))return-1;if(t.gt(c,d,!1))return 1}return 0}}(a,this.data);c.values.sort(d);c.dirty=!1;this.dirty=!0}};f.prototype.checkAllIndexes=
function(a){var b,c=this.binaryIndices,d=[],g;for(b in c)C.call(c,b)&&((g=this.checkIndex(b,a))||d.push(b));return d};f.prototype.checkIndex=function(a,b){b=b||{};b.randomSamplingFactor&&!1!==b.randomSampling&&(b.randomSampling=!0);b.randomSamplingFactor=b.randomSamplingFactor||.1;if(0>b.randomSamplingFactor||1<b.randomSamplingFactor)b.randomSamplingFactor=.1;var c=!0,d,g,e,f,l;if(!this.binaryIndices.hasOwnProperty(a))throw Error("called checkIndex on property without an index: "+a);this.adaptiveBinaryIndices||
this.ensureIndex(a);l=this.binaryIndices[a].values;f=l.length;if(f!==this.data.length)return b.repair&&this.ensureIndex(a,!0),!1;if(0===f)return!0;var h=-1!==a.indexOf(".");if(1===f)c=0===l[0];else if(b.randomSampling){if(E.$lte(r.getIn(this.data[l[0]],a,h),r.getIn(this.data[l[1]],a,h))||(c=!1),E.$lte(r.getIn(this.data[l[f-2]],a,h),r.getIn(this.data[l[f-1]],a,h))||(c=!1),c)for(g=Math.floor((f-1)*b.randomSamplingFactor),d=0;d<g-1;d++)if(e=Math.floor(Math.random()*(f-1)),!E.$lte(r.getIn(this.data[l[e]],
a,h),r.getIn(this.data[l[e+1]],a,h))){c=!1;break}}else for(d=0;d<f-1;d++)if(!E.$lte(r.getIn(this.data[l[d]],a,h),r.getIn(this.data[l[d+1]],a,h))){c=!1;break}!c&&b.repair&&this.ensureIndex(a,!0);return c};f.prototype.getBinaryIndexValues=function(a){var b,c=this.binaryIndices[a].values,d=[];for(b=0;b<c.length;b++)d.push(r.getIn(this.data[c[b]],a,!0));return d};f.prototype.ensureUniqueIndex=function(a){var b=this.constraints.unique[a];b||-1==this.uniqueNames.indexOf(a)&&this.uniqueNames.push(a);this.constraints.unique[a]=
b=new D(a);this.data.forEach(function(a){b.set(a)});return b};f.prototype.ensureAllIndexes=function(a){var b,c=this.binaryIndices;for(b in c)C.call(c,b)&&this.ensureIndex(b,a)};f.prototype.flagBinaryIndexesDirty=function(){var a,b=this.binaryIndices;for(a in b)C.call(b,a)&&(b[a].dirty=!0)};f.prototype.flagBinaryIndexDirty=function(a){this.binaryIndices[a]&&(this.binaryIndices[a].dirty=!0)};f.prototype.count=function(a){return a?this.chain().find(a).filteredrows.length:this.data.length};f.prototype.ensureId=
function(){var a=this.data.length,b=0;this.idIndex=[];for(b;b<a;b+=1)this.idIndex.push(this.data[b].$loki)};f.prototype.ensureIdAsync=function(a){this.async(function(){this.ensureId()},a)};f.prototype.addDynamicView=function(a,b){var c=new y(this,a,b);this.DynamicViews.push(c);return c};f.prototype.removeDynamicView=function(a){this.DynamicViews=this.DynamicViews.filter(function(b){return b.name!==a})};f.prototype.getDynamicView=function(a){for(var b=0;b<this.DynamicViews.length;b++)if(this.DynamicViews[b].name===
a)return this.DynamicViews[b];return null};f.prototype.findAndUpdate=function(a,b){"function"===typeof a?this.updateWhere(a,b):this.chain().find(a).update(b)};f.prototype.findAndRemove=function(a){this.chain().find(a).remove()};f.prototype.insert=function(a){if(!Array.isArray(a))return this.insertOne(a);var b,c=[];this.emit("pre-insert",a);for(var d=0,g=a.length;d<g;d++){b=this.insertOne(a[d],!0);if(!b)return;c.push(b)}this.emit("insert",c);c=this.cloneObjects?q(c,this.cloneMethod):c;return 1===c.length?
c[0]:c};f.prototype.insertOne=function(a,b){var c=null;"object"!==typeof a?c=new TypeError("Document needs to be an object"):null===a&&(c=new TypeError("Object cannot be null"));if(null!==c)throw this.emit("error",c),c;c=this.cloneObjects?q(a,this.cloneMethod):a;this.disableMeta||"undefined"!==typeof c.meta||(c.meta={revision:0,created:0});b||this.emit("pre-insert",c);if(this.add(c))return this.disableChangesApi?this.insertMeta(c):this.insertMetaWithChange(c),c=this.cloneObjects?q(c,this.cloneMethod):
c,b||this.emit("insert",c),this.addAutoUpdateObserver(c),c};f.prototype.clear=function(a){var b=this;a=a||{};this.data=[];this.idIndex=[];this.cachedData=this.cachedBinaryIndex=this.cachedIndex=null;this.maxId=0;this.DynamicViews=[];this.dirty=!0;!0===a.removeIndices?(this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[]):(Object.keys(this.binaryIndices).forEach(function(a){b.binaryIndices[a].dirty=!1;b.binaryIndices[a].values=[]}),this.constraints={unique:{},exact:{}},this.uniqueNames.forEach(function(a){b.ensureUniqueIndex(a)}))};
f.prototype.update=function(a){var b,c,d;if(Array.isArray(a)){d=a.length;if(b=!this.cloneObjects&&this.adaptiveBinaryIndices&&0<Object.keys(this.binaryIndices).length)this.adaptiveBinaryIndices=!1;try{for(c=0;c<d;c+=1)this.update(a[c])}finally{b&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}}else{if(!C.call(a,"$loki"))throw Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();var g=this.get(a.$loki,!0),e,
f,l=this;if(!g)throw Error("Trying to update a document not in collection.");e=g[0];b=g[1];f=this.cloneObjects||!this.disableDeltaChangesApi?q(a,this.cloneMethod):a;this.emit("pre-update",a);Object.keys(this.constraints.unique).forEach(function(a){l.constraints.unique[a].update(e,f)});this.data[b]=f;f!==a&&this.addAutoUpdateObserver(a);for(a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].evaluateDocument(b,!1);if(this.adaptiveBinaryIndices){var h=this.binaryIndices;for(d in h)this.adaptiveBinaryIndexUpdate(b,
d)}else this.flagBinaryIndexesDirty();this.idIndex[b]=f.$loki;this.commit();this.dirty=!0;this.disableChangesApi?this.updateMeta(f,null):this.updateMetaWithChange(f,e);var k;k=this.cloneObjects?q(f,this.cloneMethod):f;this.emit("update",k,e);return k}catch(K){throw this.rollback(),this.console.error(K.message),this.emit("error",K),K;}}};f.prototype.add=function(a){if("object"!==typeof a)throw new TypeError("Object being added needs to be an object");if("undefined"!==typeof a.$loki)throw Error("Document is already in collection, please use update()");
try{this.startTransaction();this.maxId++;isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1);a.$loki=this.maxId;this.disableMeta||(a.meta.version=0);var b,c=this.constraints.unique;for(b in c)C.call(c,b)&&c[b].set(a);this.idIndex.push(a.$loki);this.data.push(a);for(var d=this.data.length-1,g=this.DynamicViews.length,c=0;c<g;c++)this.DynamicViews[c].evaluateDocument(d,!0);if(this.adaptiveBinaryIndices){var e=this.binaryIndices;for(b in e)this.adaptiveBinaryIndexInsert(d,b)}else this.flagBinaryIndexesDirty();
this.commit();this.dirty=!0;return this.cloneObjects?q(a,this.cloneMethod):a}catch(x){throw this.rollback(),this.console.error(x.message),this.emit("error",x),x;}};f.prototype.updateWhere=function(a,b){var c=this.where(a),d=0,g;try{for(d;d<c.length;d++)g=b(c[d]),this.update(g)}catch(n){this.rollback(),this.console.error(n.message)}};f.prototype.removeWhere=function(a){"function"===typeof a?(a=this.data.filter(a),this.remove(a)):this.chain().find(a).remove()};f.prototype.removeDataOnly=function(){this.remove(this.data.slice())};
f.prototype.removeBatchByPositions=function(a){var b=a.length,c={},d,g,e,f=Object.keys(this.binaryIndices).length,l=Object.keys(this.constraints.unique).length,h=this.adaptiveBinaryIndices&&0<Object.keys(this.binaryIndices).length,k,m=this;try{this.startTransaction();for(e=0;e<b;e++)c[this.idIndex[a[e]]]=!0;d=this.DynamicViews.length;if(0<d||0<f||0<l){if(0<d)for(g=0;g<d;g++)this.DynamicViews[g].removeDocument(a);if(this.adaptiveBinaryIndices&&!h){var p,q=this.binaryIndices;for(p in q)this.adaptiveBinaryIndexRemove(a,
p)}else this.flagBinaryIndexesDirty();l&&Object.keys(this.constraints.unique).forEach(function(c){for(e=0;e<b;e++)k=m.data[a[e]],null!==k[c]&&void 0!==k[c]&&m.constraints.unique[c].remove(k[c])})}if(!this.disableChangesApi||1<this.events["delete"].length)for(e=0;e<b;e++)this.emit("delete",this.data[a[e]]);this.data=this.data.filter(function(a){return!c[a.$loki]});this.idIndex=this.idIndex.filter(function(a){return!c[a]});this.adaptiveBinaryIndices&&h&&(this.adaptiveBinaryIndices=!1,this.ensureAllIndexes(!0),
this.adaptiveBinaryIndices=!0);this.commit();this.dirty=!0}catch(P){return this.rollback(),h&&(this.adaptiveBinaryIndices=!0),this.console.error(P.message),this.emit("error",P),null}};f.prototype.removeBatch=function(a){var b=a.length,c=this.data.length,d,e={},f=[];for(d=0;d<c;d++)e[this.data[d].$loki]=d;for(d=0;d<b;d++)"object"===typeof a[d]?f.push(e[a[d].$loki]):f.push(e[a[d]]);this.removeBatchByPositions(f)};f.prototype.remove=function(a){"number"===typeof a&&(a=this.get(a));if("object"!==typeof a)throw Error("Parameter is not an object");
if(Array.isArray(a))this.removeBatch(a);else{if(!C.call(a,"$loki"))throw Error("Object is not a document stored in the collection");try{this.startTransaction();var b=this.get(a.$loki,!0),c=b[1],d=this;Object.keys(this.constraints.unique).forEach(function(b){null!==a[b]&&"undefined"!==typeof a[b]&&d.constraints.unique[b].remove(a[b])});for(var e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].removeDocument(c);if(this.adaptiveBinaryIndices){var f,h=this.binaryIndices;for(f in h)this.adaptiveBinaryIndexRemove(c,
f)}else this.flagBinaryIndexesDirty();this.data.splice(c,1);this.removeAutoUpdateObserver(a);this.idIndex.splice(c,1);this.commit();this.dirty=!0;this.emit("delete",b[0]);delete a.$loki;delete a.meta;return a}catch(l){return this.rollback(),this.console.error(l.message),this.emit("error",l),null}}};f.prototype.get=function(a,b){var c=b||!1,d=this.idIndex,e=d.length-1,f=0,h;a="number"===typeof a?a:parseInt(a,10);if(isNaN(a))throw new TypeError("Passed id is not an integer");for(;d[f]<d[e];)h=f+e>>
1,d[h]<a?f=h+1:e=h;return e===f&&d[f]===a?c?[this.data[f],f]:this.data[f]:null};f.prototype.getBinaryIndexPosition=function(a,b){var c=r.getIn(this.data[a],b,!0),d=this.binaryIndices[b].values,e=this.calculateRange("$eq",b,c);if(0===e[0]&&-1===e[1])return null;c=e[1];for(e=e[0];e<=c;e++)if(d[e]===a)return e;return null};f.prototype.adaptiveBinaryIndexInsert=function(a,b){var c=-1!==b.indexOf("."),d=this.binaryIndices[b].values,e=r.getIn(this.data[a],b,c);!0===this.serializableIndices&&e instanceof
Date&&(this.data[a][b]=e.getTime(),e=r.getIn(this.data[a],b));c=0===d.length?0:this.calculateRangeStart(b,e,!0,c);this.binaryIndices[b].values.splice(c,0,a)};f.prototype.adaptiveBinaryIndexUpdate=function(a,b){var c,d=this.binaryIndices[b].values,e=d.length;for(c=0;c<e&&d[c]!==a;c++);this.binaryIndices[b].values.splice(c,1);this.adaptiveBinaryIndexInsert(a,b)};f.prototype.adaptiveBinaryIndexRemove=function(a,b,c){var d=this.binaryIndices[b],e,f,h={},l;if(Array.isArray(a))if(f=a.length,1===f)a=a[0];
else{for(b=0;b<f;b++)h[a[b]]=!0;d.values=d.values.filter(function(a){return!h[a]});if(!0===c)return;var k=a.slice();k.sort(function(a,b){return a-b});c=d.values.length;for(e=0;e<c;e++){a=d.values[e];for(b=l=0;b<f&&a>k[b];b++)l++;d.values[e]-=l}return}f=this.getBinaryIndexPosition(a,b);if(null===f)return null;d.values.splice(f,1);if(!0!==c)for(c=d.values.length,e=0;e<c;e++)d.values[e]>a&&d.values[e]--};f.prototype.calculateRangeStart=function(a,b,c,d){var e=this.data,f=this.binaryIndices[a].values,
h=0,l=f.length-1,k;if(0===f.length)return-1;r.getIn(e[f[h]],a,d);for(r.getIn(e[f[l]],a,d);h<l;)k=h+l>>1,t.lt(r.getIn(e[f[k]],a,d),b,!1)?h=k+1:l=k;return t.aeq(b,r.getIn(e[f[h]],a,d))?h:t.lt(b,r.getIn(e[f[h]],a,d),!1)?c?h:h-1:c?h+1:h};f.prototype.calculateRangeEnd=function(a,b,c){var d=this.data,e=this.binaryIndices[a].values,f=0,h=e.length-1,l;if(0===e.length)return-1;r.getIn(d[e[f]],a,c);for(r.getIn(d[e[h]],a,c);f<h;)l=f+h>>1,t.lt(b,r.getIn(d[e[l]],a,c),!1)?h=l:f=l+1;f=h;return t.aeq(b,r.getIn(d[e[f]],
a,c))?f:t.gt(b,r.getIn(d[e[f]],a,c),!1)?f+1:t.aeq(b,r.getIn(d[e[f-1]],a,c))?f-1:f};f.prototype.calculateRange=function(a,b,c){var d=this.data,e=this.binaryIndices[b].values,f=e.length-1,h,l,k;if(0===d.length)return[0,-1];var m=-1!==b.indexOf("."),p=r.getIn(d[e[0]],b,m),q=r.getIn(d[e[f]],b,m);switch(a){case "$eq":case "$aeq":if(t.lt(c,p,!1)||t.gt(c,q,!1))return[0,-1];break;case "$dteq":if(t.lt(c,p,!1)||t.gt(c,q,!1))return[0,-1];break;case "$gt":if(t.gt(c,q,!0))return[0,-1];if(t.gt(p,c,!1))return[0,
f];break;case "$gte":if(t.gt(c,q,!1))return[0,-1];if(t.gt(p,c,!0))return[0,f];break;case "$lt":if(t.lt(c,p,!0))return[0,-1];if(t.lt(q,c,!1))return[0,f];break;case "$lte":if(t.lt(c,p,!1))return[0,-1];if(t.lt(q,c,!0))return[0,f];break;case "$between":if(t.gt(c[0],q,!1)||t.lt(c[1],p,!1))return[0,-1];h=this.calculateRangeStart(b,c[0],!1,m);k=this.calculateRangeEnd(b,c[1],m);0>h&&h++;k>f&&k--;t.gt(r.getIn(d[e[h]],b,m),c[0],!0)||h++;t.lt(r.getIn(d[e[k]],b,m),c[1],!0)||k--;return k<h?[0,-1]:[h,k];case "$in":a=
[];d=[];e=0;for(f=c.length;e<f;e++)for(h=this.calculateRange("$eq",b,c[e]),l=h[0];l<=h[1];l++)void 0===a[l]&&(a[l]=!0,d.push(l));return d}switch(a){case "$eq":case "$aeq":case "$dteq":case "$gte":case "$lt":h=this.calculateRangeStart(b,c,!1,m),l=r.getIn(d[e[h]],b,m)}switch(a){case "$eq":case "$aeq":case "$dteq":case "$lte":case "$gt":k=this.calculateRangeEnd(b,c,m),r.getIn(d[e[k]],b,m)}switch(a){case "$eq":case "$aeq":case "$dteq":return t.aeq(l,c)?[h,k]:[0,-1];case "$gt":return t.aeq(r.getIn(d[e[k]],
b,m),c)?[k+1,f]:[k,f];case "$gte":return t.aeq(r.getIn(d[e[h]],b,m),c)?[h,f]:[h+1,f];case "$lt":return t.aeq(r.getIn(d[e[h]],b,m),c)?[0,h-1]:[0,h];case "$lte":return t.aeq(r.getIn(d[e[k]],b,m),c)?[0,k]:[0,k-1];default:return[0,d.length-1]}};f.prototype.by=function(a,b){var c;if(void 0===b)return c=this,function(b){return c.by(a,b)};var d=this.constraints.unique[a].get(b);return this.cloneObjects?q(d,this.cloneMethod):d};f.prototype.findOne=function(a){a=a||{};a=this.chain().find(a,!0).data();return Array.isArray(a)&&
0===a.length?null:this.cloneObjects?q(a[0],this.cloneMethod):a[0]};f.prototype.chain=function(a,b){var c=new v(this);return"undefined"===typeof a?c:c.transform(a,b)};f.prototype.find=function(a){return this.chain().find(a).data()};f.prototype.findOneUnindexed=function(a,b){for(var c=this.data.length;c--;)if(r.getIn(this.data[c],a,!0)===b)return c=this.data[c];return null};f.prototype.startTransaction=function(){if(this.transactional){this.cachedData=q(this.data,this.cloneMethod);this.cachedIndex=
this.idIndex;this.cachedBinaryIndex=this.binaryIndices;for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].startTransaction()}};f.prototype.commit=function(){if(this.transactional){this.cachedBinaryIndex=this.cachedIndex=this.cachedData=null;for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].commit()}};f.prototype.rollback=function(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=
this.cachedBinaryIndex);for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].rollback()}};f.prototype.async=function(a,b){setTimeout(function(){if("function"===typeof a)a(),b();else throw new TypeError("Argument passed for async execution is not a function");},0)};f.prototype.where=function(a){return this.chain().where(a).data()};f.prototype.mapReduce=function(a,b){try{return b(this.data.map(a))}catch(c){throw c;}};f.prototype.eqJoin=function(a,b,c,d,e){return(new v(this)).eqJoin(a,b,c,
d,e)};f.prototype.stages={};f.prototype.getStage=function(a){this.stages[a]||(this.stages[a]={});return this.stages[a]};f.prototype.commitLog=[];f.prototype.stage=function(a,b){var c=JSON.parse(JSON.stringify(b));return this.getStage(a)[b.$loki]=c};f.prototype.commitStage=function(a,b){var c=this.getStage(a),d,e=(new Date).getTime();for(d in c)this.update(c[d]),this.commitLog.push({timestamp:e,message:b,data:JSON.parse(JSON.stringify(c[d]))});this.stages[a]={}};f.prototype.no_op=function(){};f.prototype.extract=
function(a){var b=0,c=this.data.length,d=-1!==a.indexOf("."),e=[];for(b;b<c;b+=1)e.push(G(this.data[b],a,d));return e};f.prototype.max=function(a){return Math.max.apply(null,this.extract(a))};f.prototype.min=function(a){return Math.min.apply(null,this.extract(a))};f.prototype.maxRecord=function(a){var b=0,c=this.data.length,d=-1!==a.indexOf("."),e={index:0,value:void 0},f;for(b;b<c;b+=1)void 0!==f?f<G(this.data[b],a,d)&&(f=G(this.data[b],a,d),e.index=this.data[b].$loki):(f=G(this.data[b],a,d),e.index=
this.data[b].$loki);e.value=f;return e};f.prototype.minRecord=function(a){var b=0,c=this.data.length,d=-1!==a.indexOf("."),e={index:0,value:void 0},f;for(b;b<c;b+=1)void 0!==f?f>G(this.data[b],a,d)&&(f=G(this.data[b],a,d),e.index=this.data[b].$loki):(f=G(this.data[b],a,d),e.index=this.data[b].$loki);e.value=f;return e};f.prototype.extractNumerical=function(a){return this.extract(a).map(U).filter(Number).filter(function(a){return!isNaN(a)})};f.prototype.avg=function(a){return M(this.extractNumerical(a))};
f.prototype.stdDev=function(a){return X(this.extractNumerical(a))};f.prototype.mode=function(a){var b={};this.extract(a).forEach(function(a){b[a]=b[a]?b[a]+1:1});var c,d,e;for(d in b)c?c<b[d]&&(e=d):(e=d,c=b[d]);return e};f.prototype.median=function(a){a=this.extractNumerical(a);a.sort(W);var b=Math.floor(a.length/2);return a.length%2?a[b]:(a[b-1]+a[b])/2};T.prototype={keys:[],values:[],sort:function(a,b){return a<b?-1:a>b?1:0},setSort:function(a){this.bs=new S(a)},bs:function(){return new S(this.sort)},
set:function(a,b){var c=this.bs(this.keys,a);c.found?this.values[c.index]=b:(this.keys.splice(c.index,0,a),this.values.splice(c.index,0,b))},get:function(a){return this.values[R(this.keys,a,this.sort).index]}};D.prototype.keyMap={};D.prototype.lokiMap={};D.prototype.set=function(a){var b=a[this.field];if(null!==b&&"undefined"!==typeof b){if(this.keyMap[b])throw Error("Duplicate key for property "+this.field+": "+b);this.keyMap[b]=a;this.lokiMap[a.$loki]=b}};D.prototype.get=function(a){return this.keyMap[a]};
D.prototype.byId=function(a){return this.keyMap[this.lokiMap[a]]};D.prototype.update=function(a,b){if(this.lokiMap[a.$loki]!==b[this.field]){var c=this.lokiMap[a.$loki];this.set(b);this.keyMap[c]=void 0}else this.keyMap[a[this.field]]=b};D.prototype.remove=function(a){var b=this.keyMap[a];if(null!==b&&"undefined"!==typeof b)this.keyMap[a]=void 0,this.lokiMap[b.$loki]=void 0;else throw Error("Key is not in unique index: "+this.field);};D.prototype.clear=function(){this.keyMap={};this.lokiMap={}};Q.prototype=
{set:function(a,b){this.index[a]?this.index[a].push(b):this.index[a]=[b]},remove:function(a,b){var c=this.index[a],d;for(d in c)c[d]==b&&c.splice(d,1);1>c.length&&(this.index[a]=void 0)},get:function(a){return this.index[a]},clear:function(a){this.index={}}};m.LokiOps=E;m.Collection=f;m.KeyValueStore=T;m.LokiMemoryAdapter=H;m.LokiPartitioningAdapter=F;m.LokiLocalStorageAdapter=J;m.LokiFsAdapter=I;m.persistenceAdapters={fs:I,localStorage:J};m.aeq=e;m.lt=p;m.gt=h;m.Comparators=t;return m}()});
